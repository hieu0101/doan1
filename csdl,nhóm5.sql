CREATE DATABASE QUANLYTHUVIEN
--GO
--DROP DATABASE QUANLYTHUVIEN
GO
USE QUANLYTHUVIEN
GO
CREATE TABLE SACH
(
       MASACH NVARCHAR(10) PRIMARY KEY,
       TENSACH NVARCHAR(200),
       TACGIA NVARCHAR(100),
       NGONNGU NVARCHAR(50),
       CHUYENNGANH NVARCHAR(50),
	   SOLUONGSACH INT,
	   SOLUONGDAMUON INT,
	   SOLUONGCON INT,
       NAMXUATBAN INT,
       NHAXUATBAN NVARCHAR(50),
)
GO
CREATE TABLE NHANVIEN
(
       MANV VARCHAR(10) PRIMARY KEY,
       HOTEN NVARCHAR(50),
	   NGAYSINH DATE,
	   BOPHAN NVARCHAR(50),
	   CHUCVU NVARCHAR(20),
	   GIOITINH NVARCHAR(15),
)

GO
CREATE TABLE THEDOCGIA
(      
       MATHE VARCHAR(10) PRIMARY KEY,
	   CCCD float,
	   HODEM NVARCHAR(50),
	   TEN NVARCHAR(20),
	   GIOITINH NVARCHAR(15),
	   LOAITHE NVARCHAR(30),
	   NGAYCAPTHE DATE,
	   NGAYHETHAN DATE,
	   LANMUONTHU INT,
)      
GO
CREATE TABLE MUONSACH
(
       MASACH NVARCHAR(10) FOREIGN KEY REFERENCES SACH,
	   MATHE VARCHAR(10) FOREIGN KEY REFERENCES THEDOCGIA,
	   MANV VARCHAR(10) FOREIGN KEY REFERENCES NHANVIEN,
	   SOLUONGMUON INT,
       NGAYMUON DATE,
       NGAYHENTRA DATE,
	   TINHTRANG VARCHAR(10),
       CONSTRAINT  FP_MUONSACH PRIMARY KEY (MASACH,MATHE),
)
GO
CREATE TABLE THEODOIMUONTRA
(
       MATHE VARCHAR(10) PRIMARY KEY FOREIGN KEY REFERENCES THEDOCGIA,
	   MASACH NVARCHAR(10) FOREIGN KEY REFERENCES SACH,
	   NGAYMUON DATE,
	   NGAYTRA DATE,
	   TINHTRANGSAUTRA NVARCHAR(30),
	   SOLUONGMUON INT,
	   SOLUONGTRA INT,
	   CONLAI INT,
)
GO
CREATE TABLE THUTIENPHAT
(
       MAPHIEUTHU VARCHAR(10) PRIMARY KEY,
       MATHE VARCHAR(10) REFERENCES THEDOCGIA,
	   MASACH NVARCHAR(10) FOREIGN KEY REFERENCES SACH,
	   SOTIENPHAT INT,
	   SOTIENTHU INT,
	   CONLAI INT,
	   MANV VARCHAR(10) FOREIGN KEY REFERENCES NHANVIEN,
	   LYDOPHAT NVARCHAR(100),
)
CREATE TABLE UUDAIDOCGIA
(
       MAUUDAI CHAR(15) PRIMARY KEY,
	   MATHE VARCHAR(10) REFERENCES THEDOCGIA,
	   MANV VARCHAR(10) FOREIGN KEY REFERENCES NHANVIEN,
	   GOIUUDAI NVARCHAR(50),
)
GO
USE QUANLYTHUVIEN
GO
INSERT INTO SACH(MASACH,TENSACH,TACGIA,NGONNGU,CHUYENNGANH,NAMXUATBAN,NHAXUATBAN,SOLUONGSACH,SOLUONGDAMUON,SOLUONGCON)
VALUES('S01',N'Sách tâm lý 1',N'Lưu Ánh Linh',N'Tiếng Anh',N'Văn Học',2015,N'Giáo Dục',100,67,33);
INSERT INTO SACH(MASACH,TENSACH,TACGIA,NGONNGU,CHUYENNGANH,NAMXUATBAN,NHAXUATBAN,SOLUONGSACH,SOLUONGDAMUON,SOLUONGCON)
VALUES('S02',N'Sách ngôn ngữ lập trình',N'Ngô Thành Nam',N'Tiếng Việt',N'CNTT',2015,N'Giáo Dục',150,100,50);
INSERT INTO SACH(MASACH,TENSACH,TACGIA,NGONNGU,CHUYENNGANH,NAMXUATBAN,NHAXUATBAN,SOLUONGSACH,SOLUONGDAMUON,SOLUONGCON)
VALUES('S03',N'Sách cách ứng xử',N'Mai Trúc My',N'Tiếng Việt',N'Khoa học',2015,N'Giáo Dục',200,130,70);
INSERT INTO SACH(MASACH,TENSACH,TACGIA,NGONNGU,CHUYENNGANH,NAMXUATBAN,NHAXUATBAN,SOLUONGSACH,SOLUONGDAMUON,SOLUONGCON)
VALUES('S04',N'Sách Tiếng Anh cơ bản 2',N'Atonyo',N'Tiếng Anh',N'Ngôn Ngữ Anh',2015,N'Giáo Dục',300,45,255);
INSERT INTO SACH(MASACH,TENSACH,TACGIA,NGONNGU,CHUYENNGANH,NAMXUATBAN,NHAXUATBAN,SOLUONGSACH,SOLUONGDAMUON,SOLUONGCON)
VALUES('S05',N'Sách đời sống',N'Nguyễn Ngọc Anh',N'Tiếng Việt',N'Khoa học TN',2015,N'Kim Đồng',69,19,40);
INSERT INTO SACH(MASACH,TENSACH,TACGIA,NGONNGU,CHUYENNGANH,NAMXUATBAN,NHAXUATBAN,SOLUONGSACH,SOLUONGDAMUON,SOLUONGCON)
VALUES('S06',N'HỌC CHỨNG KHOÁN',N'ELON MARK',N'TIẾNG ANH',N'LÀM GIÀU',2019,N'GIÁO DỤC',10,1,9);
SELECT * FROM SACH
GO
INSERT INTO NHANVIEN(MANV,HOTEN,NGAYSINH,BOPHAN,CHUCVU,GIOITINH)
VALUES('A01',N'ĐỖ VĂN NAM','8/2/1990',N'KHO',N'QUẢN LÝ',N'NAM');
INSERT INTO NHANVIEN(MANV,HOTEN,NGAYSINH,BOPHAN,CHUCVU,GIOITINH)
VALUES('A02',N'KHÁ BÁ NGÔ','3/7/1997',N'KHO',N'NHÂN VIÊN',N'NAM');
INSERT INTO NHANVIEN(MANV,HOTEN,NGAYSINH,BOPHAN,CHUCVU,GIOITINH)
VALUES('A03',N'LÊ Thị BÍCH','7/1/1999',N'THU NGÂN',N'NHÂN VIÊN',N'NỮ');
INSERT INTO NHANVIEN(MANV,HOTEN,NGAYSINH,BOPHAN,CHUCVU,GIOITINH)
VALUES('A04',N'NGUYỄN TIẾN ĐẠT','4/2/2000',N'QUẦY',N'NHÂN VIÊN',N'NAM');
INSERT INTO NHANVIEN(MANV,HOTEN,NGAYSINH,BOPHAN,CHUCVU,GIOITINH)
VALUES('A05',N'NGÔ THỊ HOÀ','12/3/1995',N'THU NGÂN',N'NHÂN VIÊN',N'NỮ');
INSERT INTO NHANVIEN(MANV,HOTEN,NGAYSINH,BOPHAN,CHUCVU,GIOITINH)
VALUES('A06',N'QUÁCH THỊ NGUYỆT','3/2/1989',N'QUẦY',N'QUẢN LÝ',N'NỮ');
SELECT * FROM NHANVIEN
GO
INSERT INTO THEDOCGIA(MATHE,CCCD,HODEM,TEN,GIOITINH,LOAITHE,NGAYCAPTHE,NGAYHETHAN,LANMUONTHU)
VALUES('MT201',0738047,N'Nguyễn Văn',N'Nam',N'NAM',N'SINH VIÊN','1/1/2021','9/2/2022',1);
INSERT INTO THEDOCGIA(MATHE,CCCD,HODEM,TEN,GIOITINH,LOAITHE,NGAYCAPTHE,NGAYHETHAN,LANMUONTHU)
VALUES('MT301',9382938,N'Châu Văn',N'Thông',N'NAM',N'GIẢNG VIÊN','2/1/2021','6/2/2022',3);
INSERT INTO THEDOCGIA(MATHE,CCCD,HODEM,TEN,GIOITINH,LOAITHE,NGAYCAPTHE,NGAYHETHAN,LANMUONTHU)
VALUES('MT203',3667437,N'Lê THỊ',N'HOA',N'NỮ',N'SINH VIÊN','3/1/2021','8/2/2022',1);
INSERT INTO THEDOCGIA(MATHE,CCCD,HODEM,TEN,GIOITINH,LOAITHE,NGAYCAPTHE,NGAYHETHAN,LANMUONTHU)
VALUES('MT302',8389477,N'Hà Văn',N'Hải',N'NAM',N'NGOÀI','4/1/2021','6/2/2022',4);
INSERT INTO THEDOCGIA(MATHE,CCCD,HODEM,TEN,GIOITINH,LOAITHE,NGAYCAPTHE,NGAYHETHAN,LANMUONTHU)
VALUES('MT303',3899279,N'ĐINH MAI',N'Trâm',N'NỮ',N'SINH VIÊN','5/1/2021','5/2/2022',2);
INSERT INTO THEDOCGIA(MATHE,CCCD,HODEM,TEN,GIOITINH,LOAITHE,NGAYCAPTHE,NGAYHETHAN,LANMUONTHU)
VALUES('MT102',8928110,N'Nguyễn Văn',N'Sang',N'NAM',N'GIẢNG VIÊN','6/1/2021','9/2/2022',2);
SELECT * FROM THEDOCGIA
GO
INSERT INTO MUONSACH(MASACH,MATHE,MANV,SOLUONGMUON,NGAYMUON,NGAYHENTRA,TINHTRANG)
VALUES('S03','MT201','A03',3,'4/1/2022','3/15/2022','NEW');
INSERT INTO MUONSACH(MASACH,MATHE,MANV,SOLUONGMUON,NGAYMUON,NGAYHENTRA,TINHTRANG)
VALUES('S05','MT203','A05',5,'5/4/2021','3/18/2022','NEW');
INSERT INTO MUONSACH(MASACH,MATHE,MANV,SOLUONGMUON,NGAYMUON,NGAYHENTRA,TINHTRANG)
VALUES('S02','MT303','A03',6,'1/3/2022','3/19/2022','OLD');
INSERT INTO MUONSACH(MASACH,MATHE,MANV,SOLUONGMUON,NGAYMUON,NGAYHENTRA,TINHTRANG)
VALUES('S03','MT301','A05',3,'5/6/2021','3/20/2022','OLD');
INSERT INTO MUONSACH(MASACH,MATHE,MANV,SOLUONGMUON,NGAYMUON,NGAYHENTRA,TINHTRANG)
VALUES('S04','MT302','A05',9,'6/9/2021','2/22/2022','NEW');
INSERT INTO MUONSACH(MASACH,MATHE,MANV,SOLUONGMUON,NGAYMUON,NGAYHENTRA,TINHTRANG)
VALUES('S01','MT102','A03',6,'4/7/2021','8/23/2021','NEW');
SELECT * FROM MUONSACH
GO
INSERT INTO THEODOIMUONTRA(MATHE,MASACH,NGAYMUON,NGAYTRA,TINHTRANGSAUTRA,SOLUONGMUON,SOLUONGTRA,CONLAI)
VALUES('MT201','S03','4/1/2022','3/15/2022',N'NHƯ CŨ','3','3','0');
INSERT INTO THEODOIMUONTRA(MATHE,MASACH,NGAYMUON,NGAYTRA,TINHTRANGSAUTRA,SOLUONGMUON,SOLUONGTRA,CONLAI)
VALUES('MT203','S05','5/4/2021','3/18/2022',N'BỊ RÁCH','5','2','3');
INSERT INTO THEODOIMUONTRA(MATHE,MASACH,NGAYMUON,NGAYTRA,TINHTRANGSAUTRA,SOLUONGMUON,SOLUONGTRA,CONLAI)
VALUES('MT303','S02','1/3/2022','3/19/2022',N'BỊ RÁCH','6','6','0');
INSERT INTO THEODOIMUONTRA(MATHE,MASACH,NGAYMUON,NGAYTRA,TINHTRANGSAUTRA,SOLUONGMUON,SOLUONGTRA,CONLAI)
VALUES('MT301','S03','5/6/2021','3/20/2022',N'HỎNG','3','3','0');
INSERT INTO THEODOIMUONTRA(MATHE,MASACH,NGAYMUON,NGAYTRA,TINHTRANGSAUTRA,SOLUONGMUON,SOLUONGTRA,CONLAI)
VALUES('MT302','S04','6/9/2021','2/22/2022',N'NHƯ CŨ','9','5','4');
INSERT INTO THEODOIMUONTRA(MATHE,MASACH,NGAYMUON,NGAYTRA,TINHTRANGSAUTRA,SOLUONGMUON,SOLUONGTRA,CONLAI)
VALUES('MT102','S01','4/7/2021','8/23/2021',N'NHƯ CŨ','6','6','0');
SELECT * FROM THEODOIMUONTRA
GO
INSERT INTO THUTIENPHAT(MAPHIEUTHU,MASACH,MATHE,MANV,SOTIENPHAT,SOTIENTHU,CONLAI,LYDOPHAT)
VALUES('P01','S05','MT203','A03','50000','50000','0',N'BỊ RÁCH + TRẢ THIẾU');
INSERT INTO THUTIENPHAT(MAPHIEUTHU,MASACH,MATHE,MANV,SOTIENPHAT,SOTIENTHU,CONLAI,LYDOPHAT)
VALUES('P02','S02','MT303','A03','30000','30000','0',N'BỊ RÁCH');
INSERT INTO THUTIENPHAT(MAPHIEUTHU,MASACH,MATHE,MANV,SOTIENPHAT,SOTIENTHU,CONLAI,LYDOPHAT)
VALUES('P03','S03','MT301','A05','90000','90000','0',N'HỎNG');
INSERT INTO THUTIENPHAT(MAPHIEUTHU,MASACH,MATHE,MANV,SOTIENPHAT,SOTIENTHU,CONLAI,LYDOPHAT)
VALUES('P04','S04','MT302','A05','40000','40000','0',N'TRẢ THIẾU');
SELECT * FROM THUTIENPHAT
GO
INSERT INTO UUDAIDOCGIA(MAUUDAI,MATHE,MANV,GOIUUDAI)
VALUES('U01','MT201','A03',N'GIẢM 5% LẦN TIẾP THEO')
INSERT INTO UUDAIDOCGIA(MAUUDAI,MATHE,MANV,GOIUUDAI)
VALUES('U02','MT302','A05',N'BỐC THĂM')
INSERT INTO UUDAIDOCGIA(MAUUDAI,MATHE,MANV,GOIUUDAI)
VALUES('U03','MT102','A03',N'GIẢM 15% LẦN TIẾP THEO')
SELECT * FROM UUDAIDOCGIA

GO
USE QUANLYTHUVIEN

--Xoá CỘT THU TIỀN PHẠT CÓ MÃ PHIẾU THU LÀ P04
SELECT * FROM THUTIENPHAT
DELETE FROM THUTIENPHAT  WHERE MAPHIEUTHU='P04'

--THÊM SỐ LẦN MƯỢN (+2) CỦA ĐỘC GIẢ CÓ MÃ LÀ MT301 
SELECT * FROM THEDOCGIA
UPDATE THEDOCGIA SET LANMUONTHU=5 WHERE MATHE='MT301'

--Đưa ra thông tin của tất cả các nhân viên
SELECT * FROM NHANVIEN

--Cho biết mã sách , tên sách , tác giả của SÁCH không có người mượn
SELECT S.MASACH,S.TENSACH,S.TACGIA FROM SACH S
WHERE NOT EXISTS(
SELECT MS.MASACH FROM MUONSACH MS
WHERE S.MASACH = MS.MASACH)

--Đưa ra thông tin độc giả có tên là HOA
GO
SELECT * FROM THEDOCGIA DG
WHERE DG.TEN='HOA'

--Đưa ra mã thẻ , cccd , họ tên , giới tính của độc giả bị phạt
SELECT DG.MATHE,DG.CCCD,DG.HODEM,DG.TEN,DG.GIOITINH FROM THEDOCGIA DG
WHERE EXISTS(
SELECT P.MATHE FROM THUTIENPHAT P
WHERE DG.MATHE = P.MATHE)

--Đưa ra thông tin quyển sách mà Nguyễn Văn Sang đã mượn
GO
SELECT S.MASACH,S.TENSACH,S.TACGIA,S.NGONNGU,S.CHUYENNGANH,S.NAMXUATBAN,S.NHAXUATBAN,S.SOLUONGSACH,S.SOLUONGDAMUON,S.SOLUONGCON
FROM SACH S JOIN MUONSACH MS
ON S.MASACH = MS.MASACH
JOIN THEDOCGIA DG
ON DG.MATHE = MS.MATHE
WHERE MS.MATHE = 'MT102'

--CHO BIẾT MÃ SÁCH , TÊN SÁCH , TÁC GIẢ , CHUYÊN NGÀNH LOẠI SÁCH MÀ CÓ 2 NGƯỜI MƯỢN TRỞ LÊN
SELECT S.MASACH,S.TENSACH,S.TACGIA,S.CHUYENNGANH 
FROM SACH S
WHERE S.MASACH IN(
SELECT MS.MASACH FROM MUONSACH MS
GROUP BY MS.MASACH
HAVING COUNT(MS.MASACH) >= 2)

--SẮP XẾP DANH SÁCH ĐỘC GIẢ THEO TÊN TĂNG DẦN
SELECT * FROM THEDOCGIA DG
ORDER BY DG.TEN ASC

--TÍNH TỔNG SỐ ĐỘC GIẢ CÓ GIỚI TÍNH LÀ NAM
SELECT COUNT(*) AS N'TỔNG ĐỘC GIẢ CÓ GIỚI TINH LÀ NAM' FROM THEDOCGIA
WHERE GIOITINH = N'NAM'

--ĐƯA RA THÔNG TIN PHIẾU THU TIỀN PHẠT CAO NHẤT
SELECT * FROM THUTIENPHAT P
WHERE P.SOTIENPHAT = 
(SELECT MAX(P.SOTIENPHAT) FROM THUTIENPHAT P)

--ĐƯA RA THÔNG TIN ƯU ĐÃI ĐỘC GIẢ ĐƯỢC GIẢM 5% CHO LẦN SAU
SELECT * FROM UUDAIDOCGIA UD
WHERE UD.GOIUUDAI = N'GIẢM 5% LẦN TIẾP THEO'

--ĐƯA RA THÔNG TIN ƯU ĐÃI ĐỘC GIẢ ĐƯỢC BỐC THĂM CHO LẦN SAU
SELECT * FROM UUDAIDOCGIA UD
WHERE UD.GOIUUDAI = N'BỐC THĂM'

--Đưa ra thông tin những độc giả đã mượn sách cách ứng xử
SELECT * FROM THEDOCGIA DG JOIN MUONSACH MS
ON DG.MATHE = MS.MATHE
WHERE MS.MASACH = 'S03'

--ĐƯA RA THÔNG TIN MÃ THẺ , HỌ TÊN , CCCD , GIỚI TÍNH CỦA ĐỘC GIẢ ĐÃ MƯỢN SÁCH TỪ 3 LẦN TRỞ LÊN
SELECT DG.MATHE,DG.HODEM,DG.TEN,DG.GIOITINH FROM THEDOCGIA DG
WHERE DG.LANMUONTHU >=3

--TÍNH TỔNG SỐ TIỀN PHẠT ĐÃ THU ĐƯỢC
SELECT SUM(SOTIENTHU) AS N'TỔNG SỐ TIỀN PHẠT' FROM THUTIENPHAT

--TÍNH TỔNG SỐ SÁCH ĐÃ CHO MƯỢN
SELECT SUM(SOLUONGMUON) AS N'TỔNG SỐ SÁCH ĐÃ CHO MƯỢN' FROM MUONSACH

--Sắp xếp 4 nhân viên cuối theo danh sách giảm dần
SELECT TOP(4) * FROM NHANVIEN
ORDER BY HOTEN DESC

--TÍNH TỔNG SỐ NHÂN VIÊN CỦA THƯ VIỆN
SELECT COUNT(*) AS N'TỔNG SỐ NHÂN VIÊN' FROM NHANVIEN

--Đưa ra thông tin loại sách mà các giảng viên đã mượn
SELECT S.MASACH,S.TENSACH,S.TACGIA,S.NGONNGU,S.CHUYENNGANH,S.NAMXUATBAN,S.NHAXUATBAN,S.SOLUONGSACH,S.SOLUONGDAMUON,S.SOLUONGCON
FROM SACH S JOIN MUONSACH MS
ON S.MASACH = MS.MASACH
WHERE EXISTS(
SELECT DG.LOAITHE FROM THEDOCGIA DG 
WHERE DG.MATHE = MS.MATHE
AND DG.LOAITHE = N'GIẢNG VIÊN')

--ĐƯA RA THÔNG TIN NHỮNG ĐỘC GIẢ LÀM RÁCH SÁCH
SELECT DG.MATHE,DG.CCCD,DG.HODEM,DG.TEN,DG.GIOITINH,DG.LOAITHE,DG.NGAYCAPTHE,DG.NGAYHETHAN,DG.LANMUONTHU
FROM THEDOCGIA DG JOIN THEODOIMUONTRA TD
ON DG.MATHE = TD.MATHE
WHERE TD.TINHTRANGSAUTRA = N'BỊ RÁCH'

--TÍNH TỔNG SỐ ĐỘC GIẢ ĐƯỢC ƯU ĐÃI
SELECT COUNT(*) AS N'TỔNG SỐ ĐỘC GIẢ ĐƯỢC ƯU ĐÃI'
FROM UUDAIDOCGIA

--LIỆT KỆ MASACH,TENSACH XUẤT BẢN SAU NĂM 2015
SELECT MASACH,TENSACH,NHAXUATBAN FROM SACH 
WHERE NGONNGU = N'TIẾNG ANH'
AND NAMXUATBAN > 2015

--HOTEN VÀ SỐ LƯỢNG MƯỢN TRONG NĂM 2021 VÀ TRẢ NĂM 2022
SELECT HODEM+' '+TEN AS'HỌ TÊN' ,COUNT(DG.MATHE) AS'LƯỢT MƯỢN'
FROM THEDOCGIA DG INNER JOIN MUONSACH MS ON DG.MATHE=MS.MATHE
WHERE YEAR(NGAYMUON)=2021 AND YEAR(NGAYHENTRA)=2022
GROUP BY HODEM+' '+TEN

